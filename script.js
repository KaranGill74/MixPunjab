// Music Data
const musicData = [
    {
        id: 1,
        title: "Drippy",
        artist: "Sidhu Moose Wala",
        image: "img/1.jpg",
        src: "audio/1.mp3"
    },
    {
        id: 2,
        title: "Petrol",
        artist: "Avi Sidhu & Grewal 31 31",
        image: "img/2.jpg",
        src: "audio/2.mp3"
    },
    {
        id: 3,
        title: "Desi Kalakaar",
        artist: "Yo Yo Honey Singh",
        image: "img/3.jpg",
        src: "audio/3.mp3"
    },
    {
        id: 4,
        title: "My Prime",
        artist: "Navaan Sandhu",
        image: "img/4.jpg",
        src: "audio/4.mp3"
    },
    {
        id: 5,
        title: "G.O.A.T",
        artist: "Diljit Dosanjh",
        image: "img/5.jpg",
        src: "audio/5.mp3"
    },
    {
        id: 6,
        title: "Ilzaam",
        artist: "Arjan Dhillon",
        image: "img/6.jpg",
        src: "audio/6.mp3"
    },
    {
        id: 7,
        title: "King Shit",
        artist: "Shubh",
        image: "img/7.jpg",
        src: "audio/7.mp3"
    },
    {
        id: 8,
        title: "Dead Zone",
        artist: "Gulab Sidhu",
        image: "img/8.jpg",
        src: "audio/8.mp3"
    },
    {
        id: 9,
        title: "Chal Jindiye",
        artist: "Amrinder Gill",
        image: "img/9.jpg",
        src: "audio/9.mp3"
    },
    {
        id: 10,
        title: "Regrat",
        artist: "Sidhu Moose Wala",
        image: "img/10.jpg",
        src: "audio/10.mp3"
    },
    {
        id: 11,
        title: "Maa Boldi Aa",
        artist: "Karan Aujla",
        image: "img/11.jpg",
        src: "audio/11.mp3"
    },
    {
        id: 12,
        title: "Nightmare",
        artist: "Chandra Brar",
        image: "img/12.jpg",
        src: "audio/12.mp3"
    },
    {
        id: 13,
        title: "Chandigarh Police",
        artist: "G SkillZ",
        image: "img/13.jpg",
        src: "audio/13.mp3"
    },
    {
        id: 14,
        title: "Munda Iphone Warga",
        artist: "A Key",
        image: "img/14.webp",
        src: "audio/14.mp3"
    },
    {
        id: 15,
        title: "Levels",
        artist: "Sidhu Moose wala",
        image: "img/15.jpg",
        src: "audio/15.mp3"
    },
    {
        id: 16,
        title: "Blue Eyes",
        artist: "Yo Yo Honey Singh",
        image: "img/16.jpg",
        src: "audio/16.mp3"
    },
    {
        id: 17,
        title: "Ki Banu Duniya Da",
        artist: "Gurdas Maan",
        image: "img/17.jpg",
        src: "audio/17.mp3"
    },
    {
        id: 18,
        title: "Pani Deya Bul Buleya",
        artist: "Chamkila",
        image: "img/18.jpg",
        src: "audio/18.mp3"
    },
    {
        id: 19,
        title: "Geet De Wargi",
        artist: "Tarsem Jasser",
        image: "img/19.jpg",
        src: "audio/19.mp3"
    },
    {
        id: 20,
        title: "Dabde Ni",
        artist: "Ammy Virk",
        image: "img/20.jpg",
        src: "audio/20.mp3"
    },
     {
        id: 21,
        title: "Unbothered",
        artist: "Navaan Sandhu",
        image: "img/21.jpg",
        src: "audio/21.mp3"
    },
    {
        id: 22,
        title: "Red Battiyan",
        artist: "R Nait",
        image: "img/22.jpg",
        src: "audio/22.mp3"
    },
    {
        id: 23,
        title: "Brown Munde",
        artist: "AP Dhillon",
        image: "img/23.jpg",
        src: "audio/23.mp3"
    },
    {
        id: 24,
        title: "Fuck Em All",
        artist: "Sidhu Moose Wala",
        image: "img/24.jpg",
        src: "audio/24.mp3"
    },
    {
        id: 25,
        title: "Case",
        artist: "Diljit Dosanjh",
        image: "img/25.jpg",
        src: "audio/25.mp3"
    },
    {
        id: 26,
        title: "Scapegoat",
        artist: "Sidhu Moose Wala",
        image: "img/26.jpg",
        src: "audio/26.mp3"
    },
    {
        id: 27,
        title: "Never Fold",
        artist: "Sidhu Moose Wala",
        image: "img/27.jpg",
        src: "audio/27.mp3"
    },
    {
        id: 28,
        title: "Chote Chote Ghar",
        artist: "Ranjit Bawa",
        image: "img/28.jpg",
        src: "audio/28.mp3"
    },
    {
        id: 29,
        title: "Pendu",
        artist: "Amrinder Gill",
        image: "img/29.jpg",
        src: "audio/29.mp3"
    },
    {
        id: 30,
        title: "Kaun Kuri",
        artist: "KS Makhan",
        image: "img/30.jpg",
        src: "audio/30.mp3"
    },
    {
        id: 31,
        title: "Good Luck Charm",
        artist: "KS Makhan",
        image: "img/31.jpg",
        src: "audio/31.mp3"
    },
    {
        id: 32,
        title: "Bachke Bachke",
        artist: "Karan Aujla",
        image: "img/32.jpg",
        src: "audio/32.mp3"
    },
    {
        id: 33,
        title: "Love Sick",
        artist: "Sidhu Moose Wala",
        image: "img/33.jpg",
        src: "audio/33.mp3"
    },
    {
        id: 34,
        title: "Jatt Life",
        artist: "Varinder Brar",
        image: "img/34.jpg",
        src: "audio/34.mp3"
    },
    {
        id: 35,
        title: "Foreigns",
        artist: "AP Dhillion",
        image: "img/35.jpg",
        src: "audio/35.mp3"
    },
    {
        id: 36,
        title: "Built Different",
        artist: "Sidhu Moose Wala",
        image: "img/36.jpg",
        src: "audio/36.mp3"
    },
    {
        id: 37,
        title: "Racks And Rounds",
        artist: "Sidhu Moose Wala",
        image: "img/37.jpg",
        src: "audio/37.mp3"
    },
    {
        id: 38,
        title: "Goat",
        artist: "AP Dhillion",
        image: "img/38.jpg",
        src: "audio/38.mp3"
    },
    {
        id: 39,
        title: "Jaguar",
        artist: "Bohemia",
        image: "img/39.webp",
        src: "audio/39.mp3"
    },
    {
        id: 40,
        title: "Car Nachdi",
        artist: "Gippy Grewal",
        image: "img/40.jpg",
        src: "audio/40.mp3"
    },
    {
        id: 41,
        title: "I M Better Now",
        artist: "Sidhu Moose Wala",
        image: "img/41.jpg",
        src: "audio/41.mp3"
    },
    {
        id: 42,
        title: "Same Beef",
        artist: "Sidhu Moose Wala",
        image: "img/42.jpg",
        src: "audio/42.mp3"
    },
    {
        id: 43,
        title: "Pagol",
        artist: "Deep Jandu",
        image: "img/43.jpg",
        src: "audio/43.mp3"
    },
    {
        id: 44,
        title: "2 Number",
        artist: "Aminder Gill",
        image: "img/44.jpg",
        src: "audio/44.mp3"
    },
    {
        id: 45,
        title: "Challenge",
        artist: "Ninja",
        image: "img/45.jpg",
        src: "audio/45.mp3"
    },
    {
        id: 46,
        title: "Paapi",
        artist: "Sidhu Moose Wala",
        image: "img/46.jpg",
        src: "audio/46.mp3"
    },
    {
        id: 47,
        title: "Emotional Banda",
        artist: "Ranjit Bawa",
        image: "img/47.jpg",
        src: "audio/47.mp3"
    },
    {
        id: 48,
        title: "Sohne Mukhde Da",
        artist: "Sharry Mann",
        image: "img/48.jpg",
        src: "audio/48.mp3"
    },
    {
        id: 49,
        title: "Fight",
        artist: "KS Makhan",
        image: "img/49.webp",
        src: "audio/49.mp3"
    },
    {
        id: 50,
        title: "Dildarian",
        artist: "Aminder Gill",
        image: "img/50.jpg",
        src: "audio/50.mp3"
    },
    {
        id: 51,
        title: "Meri Zindgi Bana Ja",
        artist: "Sharry Mann",
        image: "img/51.webp",
        src: "audio/51.mp3"
    },
    {
        id: 52,
        title: "Sohni Kuri",
        artist: "Amrinder Gill",
        image: "img/52.webp",
        src: "audio/52.mp3"
    },
    {
        id: 53,
        title: "Changa Mada Time",
        artist: "A-kay",
        image: "img/53.jpg",
        src: "audio/53.mp3"
    },
    {
        id: 54,
        title: "Guerrilla War",
        artist: "Amrit Maan",
        image: "img/54.jpg",
        src: "audio/54.mp3"
    },
    {
        id: 55,
        title: "Gabbroo",
        artist: "Jassi Gill",
        image: "img/55.jpg",
        src: "audio/55.mp3"
    },
    {
        id: 56,
        title: "Dil Tutda",
        artist: "Jassi Gill",
        image: "img/56.jpg",
        src: "audio/56.mp3"
    },
    {
        id: 57,
        title: "Lahore",
        artist: "Ranjit Bawa",
        image: "img/57.jpg",
        src: "audio/57.mp3"
    },
    {
        id: 58,
        title: "Guitar Sikhda",
        artist: "Jassi Gill",
        image: "img/58.jpg",
        src: "audio/58.mp3"
    },
    {
        id: 59,
        title: "Yaarian",
        artist: "Amrinder Gill",
        image: "img/59.jpg",
        src: "audio/59.mp3"
    },
    {
        id: 60,
        title: "Aroma",
        artist: "Sidhu Moose Wala",
        image: "img/60.jpg",
        src: "audio/60.mp3"
    },
    {
        id: 61,
        title: "Saahan Nu Suroor",
        artist: "Feroz Khan",
        image: "img/61.jpg",
        src: "audio/61.mp3"
    },
    {
        id: 62,
        title: "Peshi",
        artist: "Zora Randhawa",
        image: "img/62.jpg",
        src: "audio/62.mp3"
    },
    {
        id: 63,
        title: "Diary",
        artist: "Amrinder Gill",
        image: "img/63.jpg",
        src: "audio/63.mp3"
    },
    {
        id: 64,
        title: "Dil Da Dimaag",
        artist: "Sharry Maan",
        src: "audio/64.mp3",
        image: "img/64.jpg"
    },
    {
        id: 65,
        title: "Sher-E-Panjab",
        artist: "Arjan Dhillon",
        src: "audio/65.mp3",
        image: "img/65.jpg"
    },
    {
        id: 66,
        title: "Oh Kyu Ni Jaan Ske",
        artist: "Ninja",
        src: "audio/66.mp3",
        image: "img/66.jpg"
    },
    {
        id: 67,
        title: "Loud Jatt",
        artist: "Garrie Dhaliwal",
        src: "audio/67.mp3",
        image: "img/67.jpg"
    },
    {
        id: 68,
        title: "Police",
        artist: "Cheema Y",
        src: "audio/68.mp3",
        image: "img/68.jpg"
    },
    {
        id: 69,
        title: "Vaaj",
        artist: "Kanwar Grewal",
        src: "audio/69.mp3",
        image: "img/69.jpg"
    },
    {
        id: 70,
        title: "Big Scene",
        artist: "Diljit Dosanjh",
        src: "audio/70.mp3",
        image: "img/70.jpg"
    },
    
    {
        id: 71,
        title: "Jordan",
        artist: "A-Key",
        src: "audio/71.mp3",
        image: "img/71.jpg"
    },
    {
        id: 72,
        title: "Bass Baliye",
        artist: "Gurj Sidhu",
        src: "audio/72.mp3",
        image: "img/72.jpg"
    },
    {
        id: 73,
        title: "Dil Yaaran De",
        artist: "Gurj Sidhu",
        src: "audio/73.mp3",
        image: "img/73.jpg"
    },
    {
        id: 74,
        title: "Kaali Range",
        artist: "R Nait",
        src: "audio/74.mp3",
        image: "img/74.jpg"
    },
    {
        id: 75,
        title: "Adha Pind",
        artist: "Gurj Sidhu",
        src: "audio/75.mp3",
        image: "img/75.jpg"
    },
    {
        id: 76,
        title: "Flop",
        artist: "Sidhu Moose Wala",
        src: "audio/76.mp3",
        image: "img/76.jpg"
    },
    {
        id: 77,
        title: "Tru Talk",
        artist: "Jassi Gill",
        src: "audio/77.mp3",
        image: "img/77.jpg"
    },
    {
        id: 78,
        title: "Litt Lyf",
        artist: "Babble Rai",
        src: "audio/78.mp3",
        image: "img/78.jpg"
    },
    {
        id: 79,
        title: "By God",
        artist: "B Jay Randhawa",
        src: "audio/79.mp3",
        image: "img/79.webp"
    },
    {
        id: 80,
        title: "Fuel",
        artist: "Gippy Grewal",
        src: "audio/80.mp3",
        image: "img/80.jpg"
    },
    {
        id: 81,
        title: "Raatan",
        artist: "Amrinder Gill",
        src: "audio/81.mp3",
        image: "img/81.webp"
    },
    {
        id: 82,
        title: "Hauli Hauli",
        artist: "Sidhu Moose Wala",
        src: "audio/82.mp3",
        image: "img/82.jpg"
    },
    {
        id: 83,
        title: "Kaa Bole Banere Te",
        artist: "A-Key",
        src: "audio/83.mp3",
        image: "img/83.jpg"
    },
    {
        id: 84,
        title: "Sahan Ton Nere",
        artist: "Amrinder Gill",
        src: "audio/84.mp3",
        image: "img/84.jpg"
    },
    {
        id: 85,
        title: "Mitti Di Khushboo",
        artist: "Ayushmann Khurrana",
        src: "audio/85.mp3",
        image: "img/85.jpg"
    },
    {
        id: 86,
        title: "Yaari",
        artist: "Maninder Butter",
        src: "audio/86.mp3",
        image: "img/86.jpg"
    },
    {
        id: 87,
        title: "Ehna Hanjuyan",
        artist: "Kaler Kanth",
        src: "audio/87.mp3",
        image: "img/87.jpg"
    },
    {
        id: 88,
        title: "Insomnia",
        artist: "Sippy Gill",
        src: "audio/88.mp3",
        image: "img/88.webp"
    },
    {
        id: 89,
        title: "Forget About It",
        artist: "Sidhu Moose Wala",
        src: "audio/89.mp3",
        image: "img/89.webp"
    },
    {
        id: 90,
        title: "Sidhu Anthem",
        artist: "Sidhu Moose Wala",
        src: "audio/90.mp3",
        image: "img/90.jpg"
    },
    {
        id: 91,
        title: "Rang Sanwla",
        artist: "Aarsh Benipal",
        src: "audio/91.mp3",
        image: "img/91.jpg"
    },
    {
        id: 92,
        title: "Racks And Rounds",
        artist: "Sidhu Moose Wala",
        src: "audio/92.mp3",
        image: "img/92.jpg"
    },
    {
        id: 93,
        title: "Supna",
        artist: "Amrinder Gill",
        src: "audio/93.mp3",
        image: "img/93.jpg"
    },
    {
        id: 94,
        title: "Channa",
        artist: "Gippy Grewal",
        src: "audio/94.mp3",
        image: "img/94.jpg"
    },
];





// Playlist Data
const playlists = [
    {
        id: 1,
        name: "My Playlist",
        icon: "fas fa-list",
        color: "var(--primary-color)",
        songs: [1, 3, 5, 7, 9, 11, 13],
        isDefault: false
    },
    {
        id: 2,
        name: "Chill Vibes",
        icon: "fas fa-fire",
        color: "var(--secondary-color)",
        songs: [2, 4, 6, 8, 10, 12, 14],
        isDefault: false
    }
];
let downloads = [];

// Player State
let currentTrack = null;
let isPlaying = false;
let isRepeat = false;
let isShuffle = false;
let queue = [...musicData];
let currentTrackIndex = 0;
let selectedTrackForPlaylist = null;
let currentPlaylistId = null;
let recentlyPlayed = [];

// Initialize
document.addEventListener('DOMContentLoaded', function () {
    // Check for saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
    }

    const savedDownloads = localStorage.getItem('downloads');
    if (savedDownloads) {
        downloads = JSON.parse(savedDownloads);
    }

    renderMusicGrid(musicData);
    setupAudioPlayer();
    updateQueue();
    renderPlaylistSidebar();
});

// Toggle Sidebar
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.toggle('active');
}

// Toggle Theme
function toggleTheme() {
    const body = document.body;
    body.classList.toggle('light-theme');

    // Save theme preference
    if (body.classList.contains('light-theme')) {
        localStorage.setItem('theme', 'light');
        showToast('Light theme enabled');
    } else {
        localStorage.setItem('theme', 'dark');
        showToast('Dark theme enabled');
    }
}

// Render Music Grid
function renderMusicGrid(tracks, viewType = 'normal') {
    const grid = document.getElementById('musicGrid');
    grid.innerHTML = '';

    tracks.forEach(track => {
        const card = document.createElement('div');
        card.className = 'music-card';
        card.setAttribute('data-track-id', track.id);

        // Create buttons for the card
        let buttonsHtml = '';

        if (viewType === 'playlist') {
            // In playlist view, show delete button
            buttonsHtml = `
                        <button class="delete-from-playlist-btn" onclick="removeFromPlaylist(event, ${track.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
        } else if (viewType === 'download') {
            buttonsHtml = `
                        <button class="delete-from-playlist-btn" onclick="removeFromDownloads(event, ${track.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
        } else {
            // In normal view, show add to playlist and download buttons
            const isDownloaded = downloads.includes(track.id);
            buttonsHtml = `
                        <button class="add-btn" onclick="showAddToPlaylist(event, ${track.id})">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="download-btn ${isDownloaded ? 'downloaded' : ''}" onclick="toggleDownload(event, ${track.id})">
                            <i class="${isDownloaded ? 'fas fa-check' : 'fas fa-download'}"></i>
                        </button>
                    `;
        }

        const isCurrentlyPlaying = currentTrack && track.id === currentTrack.id && isPlaying;
        const playIcon = isCurrentlyPlaying ? 'fa-pause' : 'fa-play';

        card.innerHTML = `
                    <div class="music-card-image">
                        <img src="${track.image}" alt="${track.title}">
                        ${buttonsHtml}
                        <button class="like-btn ${track.liked ? 'liked' : ''}" onclick="toggleLike(event, ${track.id})">
                            <i class="${track.liked ? 'fas' : 'far'} fa-heart"></i>
                        </button>
                        <div class="play-overlay">
                            <i class="fas ${playIcon}"></i>
                        </div>
                    </div>
                    <div class="music-card-info">
                        <div class="music-card-title">${track.title}</div>
                        <div class="music-card-artist">${track.artist}</div>
                    </div>
                `;

        card.onclick = (e) => {
            // Don't trigger play if clicking on the like, add, or delete button
            if (e.target.closest('.like-btn') ||
                e.target.closest('.add-btn') ||
                e.target.closest('.delete-from-playlist-btn')) return;
            playTrack(track);
        };

        grid.appendChild(card);
    });
}

// Toggle Like
function toggleLike(event, trackId) {
    event.stopPropagation(); // Prevent triggering playTrack

    const track = musicData.find(t => t.id === trackId);
    if (track) {
        track.liked = !track.liked;

        // Update the like button
        const likeBtn = event.currentTarget;
        const icon = likeBtn.querySelector('i');

        if (track.liked) {
            likeBtn.classList.add('liked');
            icon.classList.remove('far');
            icon.classList.add('fas');
            showToast(`Added "${track.title}" to favorites`);
        } else {
            likeBtn.classList.remove('liked');
            icon.classList.remove('fas');
            icon.classList.add('far');
            showToast(`Removed "${track.title}" from favorites`);
        }

        // Update the favorites section if it's currently active
        const sectionTitle = document.getElementById('sectionTitle').textContent;
        if (sectionTitle === 'Favorites') {
            showSection('favorites');
        }
    }
}

// Toggle Download
function toggleDownload(event, trackId) {
    event.stopPropagation();

    const track = musicData.find(t => t.id === trackId);
    if (track) {
        const index = downloads.indexOf(trackId);
        if (index === -1) {
            downloads.push(trackId);
            showToast(`Downloaded "${track.title}"`);

            // Actually download the song
            const link = document.createElement('a');
            link.href = track.src;
            link.download = `${track.title}.mp3`;
            link.click();
        } else {
            downloads.splice(index, 1);
            showToast(`Removed "${track.title}" from downloads`);
        }

        // Save to localStorage
        localStorage.setItem('downloads', JSON.stringify(downloads));

        // Update the download button
        const downloadBtn = event.currentTarget;
        const icon = downloadBtn.querySelector('i');
        if (downloads.includes(trackId)) {
            downloadBtn.classList.add('downloaded');
            icon.classList.remove('fa-download');
            icon.classList.add('fa-check');
        } else {
            downloadBtn.classList.remove('downloaded');
            icon.classList.remove('fa-check');
            icon.classList.add('fa-download');
        }

        // Update the download section if it's currently active
        const sectionTitle = document.getElementById('sectionTitle').textContent;
        if (sectionTitle === 'Download') {
            showSection('download');
        }
    }
}

function removeFromDownloads(event, trackId) {
    event.stopPropagation();

    const track = musicData.find(t => t.id === trackId);
    if (track) {
        const index = downloads.indexOf(trackId);
        if (index !== -1) {
            downloads.splice(index, 1);
            localStorage.setItem('downloads', JSON.stringify(downloads));
            showToast(`Removed "${track.title}" from downloads`);

            // Update the download section if it's currently active
            const sectionTitle = document.getElementById('sectionTitle').textContent;
            if (sectionTitle === 'Download') {
                showSection('download');
            }
        }
    }
}

// Remove from Playlist
function removeFromPlaylist(event, trackId) {
    event.stopPropagation(); // Prevent triggering playTrack

    if (!currentPlaylistId) return;

    const playlist = playlists.find(p => p.id === currentPlaylistId);
    if (!playlist) return;

    const track = musicData.find(t => t.id === trackId);
    if (!track) return;

    // Remove track from playlist
    const index = playlist.songs.indexOf(trackId);
    if (index !== -1) {
        playlist.songs.splice(index, 1);

        // Show notification
        showToast(`Removed "${track.title}" from "${playlist.name}"`);

        // Update the UI
        showPlaylist(currentPlaylistId);

        // Update playlist sidebar
        renderPlaylistSidebar();
    }
}

// Show Add to Playlist Modal
function showAddToPlaylist(event, trackId) {
    event.stopPropagation(); // Prevent triggering playTrack

    selectedTrackForPlaylist = musicData.find(t => t.id === trackId);

    // Render playlist options
    const playlistOptions = document.getElementById('playlistOptions');
    playlistOptions.innerHTML = '';

    playlists.forEach(playlist => {
        const option = document.createElement('div');
        option.className = 'playlist-option';
        option.innerHTML = `
                    <div class="playlist-option-icon" style="background: ${playlist.color};">
                        <i class="${playlist.icon}"></i>
                    </div>
                    <div>
                        <div>${playlist.name}</div>
                        <small style="color: var(--text-secondary);">${playlist.songs.length} songs</small>
                    </div>
                `;

        option.onclick = () => addTrackToPlaylist(playlist.id);
        playlistOptions.appendChild(option);
    });

    // Show the modal
    document.getElementById('playlistModal').classList.add('active');
}

// Add Track to Playlist
function addTrackToPlaylist(playlistId) {
    const playlist = playlists.find(p => p.id === playlistId);

    if (playlist && selectedTrackForPlaylist) {
        // Check if track is already in playlist
        if (!playlist.songs.includes(selectedTrackForPlaylist.id)) {
            playlist.songs.push(selectedTrackForPlaylist.id);
            showToast(`Added "${selectedTrackForPlaylist.title}" to "${playlist.name}"`);

            // Update playlist sidebar
            renderPlaylistSidebar();

            // Update playlist options in modal
            const playlistOptions = document.getElementById('playlistOptions');
            playlistOptions.innerHTML = '';

            playlists.forEach(p => {
                const option = document.createElement('div');
                option.className = 'playlist-option';
                option.innerHTML = `
                            <div class="playlist-option-icon" style="background: ${p.color};">
                                <i class="${p.icon}"></i>
                            </div>
                            <div>
                                <div>${p.name}</div>
                                <small style="color: var(--text-secondary);">${p.songs.length} songs</small>
                            </div>
                        `;

                option.onclick = () => addTrackToPlaylist(p.id);
                playlistOptions.appendChild(option);
            });
        } else {
            showToast(`"${selectedTrackForPlaylist.title}" is already in "${playlist.name}"`);
        }
    }
}

// Create New Playlist
function createNewPlaylist() {
    const name = prompt('Enter playlist name:');

    if (name && selectedTrackForPlaylist) {
        const newPlaylist = {
            id: playlists.length + 1,
            name: name,
            icon: "fas fa-music",
            color: "var(--accent)",
            songs: [selectedTrackForPlaylist.id],
            isDefault: false
        };

        playlists.push(newPlaylist);

        // Update playlist sidebar
        renderPlaylistSidebar();

        // Update playlist options in modal
        const playlistOptions = document.getElementById('playlistOptions');
        playlistOptions.innerHTML = '';

        playlists.forEach(p => {
            const option = document.createElement('div');
            option.className = 'playlist-option';
            option.innerHTML = `
                        <div class="playlist-option-icon" style="background: ${p.color};">
                            <i class="${p.icon}"></i>
                        </div>
                        <div>
                            <div>${p.name}</div>
                            <small style="color: var(--text-secondary);">${p.songs.length} songs</small>
                        </div>
                    `;

            option.onclick = () => addTrackToPlaylist(p.id);
            playlistOptions.appendChild(option);
        });

        showToast(`Created playlist "${name}" and added "${selectedTrackForPlaylist.title}"`);
    }
}

// Create Playlist
function createPlaylist() {
    const name = prompt('Enter playlist name:');
    if (name) {
        const newPlaylist = {
            id: playlists.length + 1,
            name: name,
            icon: "fas fa-music",
            color: "var(--accent)",
            songs: [],
            isDefault: false
        };

        playlists.push(newPlaylist);
        renderPlaylistSidebar();
        showToast(`Playlist "${name}" created`);
    }
}

// Delete Playlist
function deletePlaylist(playlistId, event) {
    event.stopPropagation(); // Prevent triggering playlist selection

    const playlist = playlists.find(p => p.id === playlistId);

    if (playlist && !playlist.isDefault) {
        if (confirm(`Are you sure you want to delete "${playlist.name}"?`)) {
            // Remove playlist from array
            const index = playlists.findIndex(p => p.id === playlistId);
            if (index !== -1) {
                playlists.splice(index, 1);
                renderPlaylistSidebar();
                showToast(`Playlist "${playlist.name}" deleted`);

                // If we were viewing the deleted playlist, go back to library
                if (currentPlaylistId === playlistId) {
                    currentPlaylistId = null;
                    showSection('library');
                }
            }
        }
    }
}

// Shuffle Playlist
function shufflePlaylist() {
    if (!currentPlaylistId) return;

    const playlist = playlists.find(p => p.id === currentPlaylistId);
    if (!playlist) return;

    // Shuffle the songs array
    for (let i = playlist.songs.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [playlist.songs[i], playlist.songs[j]] = [playlist.songs[j], playlist.songs[i]];
    }

    // Update the UI
    showPlaylist(currentPlaylistId);
    showToast(`Shuffled "${playlist.name}"`);
}

// Clear Playlist
function clearPlaylist() {
    if (!currentPlaylistId) return;

    const playlist = playlists.find(p => p.id === currentPlaylistId);
    if (!playlist) return;

    if (confirm(`Are you sure you want to clear all songs from "${playlist.name}"?`)) {
        playlist.songs = [];

        // Update the UI
        showPlaylist(currentPlaylistId);
        showToast(`Cleared "${playlist.name}"`);
    }
}

// Close Playlist Modal
function closePlaylistModal() {
    document.getElementById('playlistModal').classList.remove('active');
    selectedTrackForPlaylist = null;
}

// Render Playlist Sidebar
function renderPlaylistSidebar() {
    const playlistList = document.getElementById('playlistList');
    playlistList.innerHTML = '';

    playlists.forEach(playlist => {
        const item = document.createElement('div');
        item.className = 'playlist-item';

        // Only show cancel button for non-default playlists
        const cancelButton = !playlist.isDefault ?
            `<button class="cancel-playlist" onclick="deletePlaylist(${playlist.id}, event)">
                        <i class="fas fa-times"></i>
                    </button>` : '';

        item.innerHTML = `
                    <div class="playlist-icon" style="background: ${playlist.color};">
                        <i class="${playlist.icon}"></i>
                    </div>
                    <div class="playlist-info">
                        <div>${playlist.name}</div>
                        <small style="color: var(--text-secondary);">${playlist.songs.length} songs</small>
                    </div>
                    ${cancelButton}
                `;

        item.onclick = (e) => {
            // Don't trigger playlist selection if clicking on the cancel button
            if (e.target.closest('.cancel-playlist')) return;
            showPlaylist(playlist.id);
        };

        playlistList.appendChild(item);
    });
}

// Show Playlist
function showPlaylist(playlistId) {
    const playlist = playlists.find(p => p.id === playlistId);

    if (playlist) {
        // Set current playlist ID
        currentPlaylistId = playlistId;

        // Update section title and description
        document.getElementById('sectionTitle').textContent = playlist.name;
        document.getElementById('sectionDescription').textContent = `${playlist.songs.length} songs`;

        // Show playlist actions
        document.getElementById('playlistActions').style.display = 'flex';

        // Get songs in playlist
        const playlistSongs = musicData.filter(track =>
            playlist.songs.includes(track.id)
        );

        // Render music grid with playlist songs
        renderMusicGrid(playlistSongs, 'playlist');

        // Update active nav item
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
    }
}

// Setup Audio Player
function setupAudioPlayer() {
    const audio = document.getElementById('audioPlayer');

    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', updateDuration);
    audio.addEventListener('ended', handleTrackEnd);
}

// Play Track
function playTrack(track) {
    currentTrack = track;
    currentTrackIndex = queue.findIndex(t => t.id === track.id);

    // Add to recently played
    const existingIndex = recentlyPlayed.findIndex(t => t.id === track.id);
    if (existingIndex !== -1) {
        recentlyPlayed.splice(existingIndex, 1);
    }
    recentlyPlayed.unshift(track);
    if (recentlyPlayed.length > 10) {
        recentlyPlayed.pop();
    }

    const audio = document.getElementById('audioPlayer');
    audio.src = track.src;
    audio.play();

    isPlaying = true;
    updatePlayerUI();
    updateNowPlayingUI();
    showToast(`Now playing: ${track.title}`);
}

// Toggle Play/Pause
function togglePlayPause() {
    const audio = document.getElementById('audioPlayer');

    if (!currentTrack) {
        if (queue.length > 0) {
            playTrack(queue[0]);
        }
        return;
    }

    if (isPlaying) {
        audio.pause();
    } else {
        audio.play();
    }

    isPlaying = !isPlaying;
    updatePlayPauseButton();
    updatePlayerUI();
}

// Update Play/Pause Button
function updatePlayPauseButton() {
    const playBtn = document.getElementById('playPauseBtn');
    const playBtnFull = document.getElementById('playPauseBtnFull');
    const icon = isPlaying ? 'fa-pause' : 'fa-play';

    playBtn.innerHTML = `<i class="fas ${icon}"></i>`;
    playBtnFull.innerHTML = `<i class="fas ${icon}"></i>`;
}

// Previous Track
function previousTrack() {
    if (queue.length === 0) return;

    currentTrackIndex = currentTrackIndex > 0 ? currentTrackIndex - 1 : queue.length - 1;
    playTrack(queue[currentTrackIndex]);
}

// Next Track
function nextTrack() {
    if (queue.length === 0) return;

    if (isShuffle) {
        currentTrackIndex = Math.floor(Math.random() * queue.length);
    } else {
        currentTrackIndex = (currentTrackIndex + 1) % queue.length;
    }

    playTrack(queue[currentTrackIndex]);
}

// Handle Track End
function handleTrackEnd() {
    if (isRepeat) {
        const audio = document.getElementById('audioPlayer');
        audio.currentTime = 0;
        audio.play();
    } else {
        nextTrack();
    }
}

// Update Progress
function updateProgress() {
    const audio = document.getElementById('audioPlayer');
    const progress = (audio.currentTime / audio.duration) * 100;

    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressBarFull').style.width = progress + '%';

    document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
    document.getElementById('currentTimeFull').textContent = formatTime(audio.currentTime);
}

// Update Duration
function updateDuration() {
    const audio = document.getElementById('audioPlayer');
    document.getElementById('duration').textContent = formatTime(audio.duration);
    document.getElementById('durationFull').textContent = formatTime(audio.duration);
}

// Format Time
function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';

    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Seek To
function seekTo(event) {
    const audio = document.getElementById('audioPlayer');
    const progressBar = event.currentTarget;
    const clickX = event.offsetX;
    const width = progressBar.offsetWidth;
    const percentage = clickX / width;

    audio.currentTime = percentage * audio.duration;
}

function setVolume(event) {
    const audio = document.getElementById('audioPlayer');
    const volumeSlider = event.currentTarget;

    // Get click position correctly
    const rect = volumeSlider.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const width = volumeSlider.offsetWidth;
    let percentage = clickX / width;

    // Keep percentage between 0 and 1
    percentage = Math.min(Math.max(percentage, 0), 1);

    // Set volume
    audio.volume = percentage;

    // Update UI
    const volumeLevel = document.getElementById('volumeLevel');
    const volumeLevelFull = document.getElementById('volumeLevelFull');

    if (volumeLevel) volumeLevel.style.width = (percentage * 100) + '%';
    if (volumeLevelFull) volumeLevelFull.style.width = (percentage * 100) + '%';
}


// Toggle Repeat

// Toggle Repeat
function toggleRepeat() {
    isRepeat = !isRepeat;
    const repeatBtn = document.getElementById('repeatBtn');
    const repeatBtnFull = document.getElementById('repeatBtnFull');

    if (repeatBtn) repeatBtn.style.color = isRepeat ? 'var(--primary-color)' : '';
    if (repeatBtnFull) repeatBtnFull.style.color = isRepeat ? 'var(--primary-color)' : '';

    showToast(isRepeat ? 'Repeat mode ON' : 'Repeat mode OFF');
}

// Toggle Shuffle
function toggleShuffle() {
    isShuffle = !isShuffle;
    const shuffleBtn = document.getElementById('shuffleBtn');
    const shuffleBtnFull = document.getElementById('shuffleBtnFull');

    if (shuffleBtn) shuffleBtn.style.color = isShuffle ? 'var(--primary-color)' : '';
    if (shuffleBtnFull) shuffleBtnFull.style.color = isShuffle ? 'var(--primary-color)' : '';

    showToast(isShuffle ? 'Shuffle mode ON' : 'Shuffle mode OFF');
}

// Update Player UI
function updatePlayerUI() {
    if (!currentTrack) return;

    document.getElementById('playerImage').src = currentTrack.image;
    document.getElementById('playerTitle').textContent = currentTrack.title;
    document.getElementById('playerArtist').textContent = currentTrack.artist;

    updatePlayPauseButton();

    // Update playing indicator
    document.querySelectorAll('.music-card').forEach(card => {
        card.classList.remove('playing');
        const overlay = card.querySelector('.play-overlay i');
        if (overlay) overlay.className = 'fas fa-play';
    });

    const currentCard = document.querySelector(`.music-card[data-track-id="${currentTrack.id}"]`);
    if (currentCard) {
        currentCard.classList.add('playing');
        const overlay = currentCard.querySelector('.play-overlay i');
        if (overlay) overlay.className = 'fas fa-pause';
    }
}

// Update Now Playing UI
function updateNowPlayingUI() {
    if (!currentTrack) return;

    document.getElementById('nowPlayingImage').src = currentTrack.image;
    document.getElementById('nowPlayingTitle').textContent = currentTrack.title;
    document.getElementById('nowPlayingArtist').textContent = currentTrack.artist;
}

// Show Now Playing
function showNowPlaying() {
    document.getElementById('nowPlayingView').classList.add('active');
}

// Close Now Playing
function closeNowPlaying() {
    document.getElementById('nowPlayingView').classList.remove('active');
}

// Update Queue
function updateQueue() {
    const queueList = document.getElementById('queueList');
    queueList.innerHTML = '';

    queue.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'queue-item';
        if (currentTrack && track.id === currentTrack.id) {
            item.classList.add('active');
        }

        item.innerHTML = `
                    <div class="queue-item-image">
                        <img src="${track.image}" alt="${track.title}">
                    </div>
                    <div class="queue-item-info">
                        <div class="queue-item-title">${track.title}</div>
                        <div class="queue-item-artist">${track.artist}</div>
                    </div>
                    <div class="queue-item-duration">${track.duration}</div>
                `;

        item.onclick = () => playTrack(track);
        queueList.appendChild(item);
    });
}

// Clear Queue
function clearQueue() {
    queue = [];
    currentTrackIndex = 0;
    updateQueue();
    showToast('Queue cleared');
}

// Update Section Content
function updateSectionContent(section) {
    // Reset current playlist ID when not viewing a playlist
    currentPlaylistId = null;

    // Hide actions
    document.getElementById('playlistActions').style.display = 'none';
    document.getElementById('recentActions').style.display = 'none';

    // Update content based on section
    const titles = {
        'library': 'Library',
        'recent': 'Recently Played',
        'favorites': 'Favorites',
        'download': 'Download',
        'settings': 'Settings'
    };

    const descriptions = {
        'library': 'Your music collection',
        'recent': 'Songs you played recently',
        'favorites': 'Your favorite tracks',
        'download': 'Your downloaded songs',
        'settings': 'Player settings'
    };

    document.getElementById('sectionTitle').textContent = titles[section] || 'Library';
    document.getElementById('sectionDescription').textContent = descriptions[section] || 'Your music collection';

    // Filter tracks based on section
    let filteredTracks = musicData;
    let viewType = 'normal';

    if (section === 'favorites') {
        filteredTracks = musicData.filter(track => track.liked);
    } else if (section === 'recent') {
        filteredTracks = recentlyPlayed;
        document.getElementById('recentActions').style.display = 'flex';
    } else if (section === 'download') {
        filteredTracks = musicData.filter(track => downloads.includes(track.id));
        viewType = 'download';
    }

    renderMusicGrid(filteredTracks, viewType);
}

// Show Section
function showSection(section) {
    updateSectionContent(section);

    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    const activeItem = document.querySelector(`.nav-item[data-section="${section}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
}

// Clear Recent
function clearRecent() {
    recentlyPlayed = [];
    updateSectionContent('recent');
    showToast('Recent cleared');
}

// Show Equalizer
function showEqualizer() {
    document.getElementById('equalizerModal').classList.add('active');
}

// Close Equalizer
function closeEqualizer() {
    document.getElementById('equalizerModal').classList.remove('active');
}

// Adjust EQ
function adjustEQ(event, frequency) {
    const slider = event.currentTarget;
    const clickY = event.offsetY;
    const height = slider.offsetHeight;
    const percentage = 1 - (clickY / height);

    const level = document.getElementById(`eq-${frequency}`);
    level.style.height = (percentage * 100) + '%';
}

// Apply EQ Preset
function applyEQPreset(preset) {
    const presets = {
        'normal': [50, 50, 50, 50, 50],
        'classical': [40, 40, 60, 60, 50],
        'rock': [70, 50, 60, 70, 60],
        'pop': [60, 50, 50, 60, 50],
        'jazz': [50, 60, 50, 50, 60],
        'bass': [80, 70, 50, 40, 30]
    };

    const frequencies = ['60', '230', '910', '4k', '14k'];
    const values = presets[preset];

    frequencies.forEach((freq, index) => {
        const level = document.getElementById(`eq-${freq}`);
        level.style.height = values[index] + '%';
    });

    showToast(`${preset.charAt(0).toUpperCase() + preset.slice(1)} preset applied`);
}

// Search Functionality
document.getElementById('searchInput').addEventListener('input', function (e) {
    const searchTerm = e.target.value.toLowerCase().trim();

    if (!searchTerm) {
        renderMusicGrid(musicData);
    } else {
        const filtered = musicData.filter(track => {
            const title = track.title ? track.title.toLowerCase() : '';
            const artist = track.artist ? track.artist.toLowerCase() : '';
            const album = track.album ? track.album.toLowerCase() : '';

            return title.includes(searchTerm) ||
                   artist.includes(searchTerm) ||
                   album.includes(searchTerm);
        });
        renderMusicGrid(filtered);
    }
});


// Show Toast
function showToast(message) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    toastMessage.textContent = message;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Keyboard Shortcuts
document.addEventListener('keydown', function (e) {
    switch (e.code) {
        case 'Space':
            e.preventDefault();
            togglePlayPause();
            break;
        case 'ArrowLeft':
            previousTrack();
            break;
        case 'ArrowRight':
            nextTrack();
            break;
        case 'ArrowUp':
            e.preventDefault();
            const audio = document.getElementById('audioPlayer');
            audio.volume = Math.min(1, audio.volume + 0.1);
            break;
        case 'ArrowDown':
            e.preventDefault();
            const audio2 = document.getElementById('audioPlayer');
            audio2.volume = Math.max(0, audio2.volume - 0.1);
            break;
        case 'Escape':
            closeNowPlaying();
            closeEqualizer();
            closePlaylistModal();
            break;
    }

});